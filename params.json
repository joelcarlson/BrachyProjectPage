{"name":"Brachytherapy Research","tagline":"Calculations and Data","body":"---\r\nlayout: page\r\ntitle: \"Brachytherapy Reproducible Research\"\r\npermalink: /brachytherapyRepro/\r\n---\r\n##Introduction\r\n\r\nIn this document I will explain the calculations required to obtain TG-43 parameters for a new brachytherapy seed. The document contains  R functions capable of calculating all required quantities of interest in a reproducible fashion.\r\n\r\n##Calculated quantities\r\n\r\n###Geometry Function\r\n\r\nThe first required quantity is the **Geometry Function**.  The purpose of the geometry function is to improve the accuracy with which dose rates can be estimated through interpolation. The line source model is recommended in [TG-43](https://www.aapm.org/pubs/reports/rpt_84.pdf), with geometry as in this diagram:\r\n\r\n<img src=\"http://i.imgur.com/LArTEEz.png\" title=\"source: imgur.com\" />\r\n\r\nThe equation for the Geometry function is as follows:\r\n\r\n<img src=\"http://i.imgur.com/zuuOzh2.png\" title=\"source: imgur.com\" />\r\n\r\nTo calculate the geometry function we define several function.  The equations for each side of the diagram, and \\\\(\\beta\\\\), and use the outputs from these functions to calculate the geometry function:\r\n\r\n{% highlight r %}\r\nBeta <- function(theta, r, L=0.3){\r\n    side1 <- sqrt((L/2)^2 + r^2 - L*r*cos(pi - theta))\r\n    side2 <- sqrt((L/2)^2 + r^2 - L*r*cos(theta))\r\n    beta <- acos((side1^2 + side2^2 - L^2)/(2*side1*side2))   \r\n    return(beta)\r\n}    \r\n \r\nGeomFunction <- function(theta, r, L=0.3){\r\n    if(theta == 0){geom <- 1/(r^2 - (L^2)/4)}\r\n    else{geom <- Beta(theta, r, L)/(L*r*sin(theta))}\r\n    return(geom)    \r\n}\r\n\r\n#Example calculation:\r\nGeomFunction(pi/18, 10,0.3)\r\n{% endhighlight %}\r\n\r\n\r\n\r\n{% highlight text %}\r\n## [1] 0.01\r\n{% endhighlight %}\r\n\r\n##Measured Quantities\r\n\r\nAll measured quantities are \"measured\" using Monte Carlo simulation.  In this case, MCNPX was used for calculation.  The rest of the document will assume that the Mone Carlo calculations are complete, and the output files are organized in a directory structure such as this:\r\n\r\n<img src=\"http://i.imgur.com/GzQqm6E.png\" title=\"source: imgur.com\" />\r\n\r\n###Dose Rate Constant\r\n\r\nThe output file should look like this: [MCNP output file](https://raw.githubusercontent.com/joelcarlson/Reproducible-TG43-Brachytherapy/master/Aug28KAERIFA.txt).\r\n\r\nThis output file contains the detector element surfaces relevant to calculating 2D anisotropy, hence the many warnings, however they do not alter the output in any way. A function must be written to extract the relevant detector cell tallies described in this diagram, where F6 indicates the track length estimator tally in MCNPX:\r\n\r\n<img src=\"http://i.imgur.com/g2Jd0fg.png\" title=\"source: imgur.com\" />\r\n\r\nDose rate constant is calculated as:\r\n\r\n<img src=\"http://i.imgur.com/qxnGZvk.png\" title=\"source: imgur.com\" />\r\n\r\nGiven the output file we define a function to extract the cell tally values and use them to calculate the dose rate constant of the seed:\r\n\r\n{% highlight r %}\r\nlibrary(stringr)\r\n\r\ndoseRC <- function(upper.cell = 803, lower.cell = 802, r=30, file.path= \"DoseRateOutfile/KAERIFreeAir.txt\"){\r\n    #Read the output file\r\n    sctext <- scan(file.path, character(0), sep = \"\\n\")\r\n    \r\n    #Find and extract tally value, then trim whitespace and extract value \r\n    ##Upper tally\r\n    upper <- which(is.na(str_extract(sctext,paste0(\"cell  \",upper.cell)))==FALSE)\r\n    upper <- sctext[upper + 1]\r\n    upper <- as.numeric(unlist(str_split(str_trim(upper), \" \"))[1])\r\n    \r\n    ##Lower tally\r\n    lower <- which(is.na(str_extract(sctext,paste0(\"cell  \",lower.cell)))==FALSE)\r\n    lower <- sctext[lower + 1]\r\n    lower <- as.numeric(unlist(str_split(str_trim(lower), \" \"))[1])\r\n    \r\n    #calculate air kerma\r\n    doseRC <- lower/(upper * (r^2))\r\n    return(doseRC)\r\n}   \r\n\r\ndoseRC()\r\n{% endhighlight %}\r\n\r\n\r\n\r\n{% highlight text %}\r\n## [1] 0.9174\r\n{% endhighlight %}\r\n\r\n###Radial Dose Function\r\n\r\nThe next quantity of interest to calculate is the **Radial Dose Function**, \\\\(g_L(r)\\\\).  The formula is as follows:\r\n\r\n<img src=\"http://i.imgur.com/WfRfmk5.png\" title=\"source: imgur.com\" />\r\n\r\nTherefore we need to access the tally values from our output from the simulation with the detectors on the transverse plane (ie. \\\\(\\theta_0\\\\)). The output file should look like this: [example output file](https://raw.githubusercontent.com/joelcarlson/Reproducible-TG43-Brachytherapy/master/KAERI_90_out.txt).\r\n\r\nA similar method is used as for the extraction of the dose rate constant.  To note, the input of the function called `cell.range` is the range of cells used to define the detector elements (tallies), and `radii` is a vector containing the distance of each detector element from the seed.\r\n\r\n\r\n{% highlight r %}\r\n##Find F6 tally value at given cell range and radii, outputs a dataframe containing D(r,90)\r\nDr90 <- function(cell.range = c(223:246), radii=c(0.25,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1,1.25,1.5,1.75,2,2.5,3,3.5,4,4.5,5,6,7,8,9,10), file.path= \"AnisoOutFiles/KAERI_90_out.txt\"){\r\n    #Read the output file\r\n    sctext <- scan(file.path, character(0), sep = \"\\n\")\r\n    f6vals <- c()\r\n    for(i in cell.range){\r\n      cellval <- which(is.na(str_extract(sctext,paste0(\"cell  \",i)))==FALSE)\r\n      cellval <- sctext[cellval + 1]\r\n      cellval <- as.numeric(unlist(str_split(str_trim(cellval), \" \"))[1])\r\n      f6vals <- append(f6vals, cellval)\r\n    }\r\n    \r\n    Dr90 <- data.frame(\"r\"=radii, \"Dr90\"=f6vals )\r\n    return(Dr90)\r\n}\r\n\r\n##Use our GeomFunction and Dr90 to calculate the radial dose function \r\nRadialDoseFunction <- function(){\r\n  #Define values\r\n  Dr90 <- Dr90()\r\n  D190 <- Dr90[Dr90$r==1.00,\"Dr90\"]\r\n  GLr90 <- c()\r\n  for(i in Dr90[,\"r\"]){\r\n      GLr90 <- append(GLr90,GeomFunction(pi/2, i))\r\n  }\r\n  GL190 <- GeomFunction(pi/2, 1)\r\n  \r\n  RDtable <- data.frame(Dr90, GLr90)\r\n  \r\n  RDtable$gLr <- (RDtable$Dr90 / D190) * (GL190 / RDtable$GLr90)\r\n  return(RDtable)\r\n}\r\n\r\nRadialDoseFunction()\r\n{% endhighlight %}\r\n\r\n\r\n\r\n{% highlight text %}\r\n##        r      Dr90     GLr90     gLr\r\n## 1   0.25 3.658e-03 14.411187 1.08665\r\n## 2   0.30 2.611e-03 10.303280 1.08473\r\n## 3   0.40 1.506e-03  5.979511 1.07839\r\n## 4   0.50 9.696e-04  3.886091 1.06812\r\n## 5   0.60 6.718e-04  2.721985 1.05652\r\n## 6   0.70 4.900e-04  2.010413 1.04354\r\n## 7   0.80 3.717e-04  1.544566 1.03029\r\n## 8   0.90 2.901e-04  1.223324 1.01540\r\n## 9   1.00 2.319e-04  0.992600 1.00000\r\n## 10  1.25 1.425e-04  0.636954 0.95755\r\n## 11  1.50 9.441e-05  0.442972 0.91241\r\n## 12  1.75 6.586e-05  0.325734 0.86557\r\n## 13  2.00 4.773e-05  0.249533 0.81896\r\n## 14  2.50 2.714e-05  0.159808 0.72719\r\n## 15  3.00 1.661e-05  0.111019 0.64063\r\n## 16  3.50 1.068e-05  0.081583 0.56059\r\n## 17  4.00 7.134e-06  0.062471 0.48886\r\n## 18  4.50 4.894e-06  0.049364 0.42439\r\n## 19  5.00 3.434e-06  0.039988 0.36762\r\n## 20  6.00 1.779e-06  0.027772 0.27418\r\n## 21  7.00 9.681e-07  0.020405 0.20311\r\n## 22  8.00 5.465e-07  0.015623 0.14974\r\n## 23  9.00 3.176e-07  0.012345 0.11016\r\n## 24 10.00 1.892e-07  0.009999 0.08102\r\n{% endhighlight %}\r\n\r\n###2D Anisotropy Function\r\n\r\nThe next and final calculation is of the **2D anisotropy function**.  The formula for the 2D anisotropy function is:\r\n\r\n<img src=\"http://i.imgur.com/X3on0Ng.png\" title=\"source: imgur.com\" />\r\n\r\nFor this function, the data is stored across several different output files in the folder `AnisoOutFiles`.  There exists one output file every \\\\(10^{\\circ}\\\\) for a total of 10 files (for publication quality it is recommended that every \\\\(5^{\\circ}\\\\) be sampled.)\r\n\r\nBased on our detector cell definitions, the detectors along \\\\(\\theta = 0\\\\) go from 7 to 30, \\\\(\\theta = 10\\\\) from 31 to 54 and so on (\\\\(\\theta = 90\\\\) from 223 to 246, as in the radial dose function calculation).\r\n\r\nThe first step is to create a function to extract the tally values and build a data frame based on them:\r\n\r\n{% highlight r %}\r\n#Build dataframe of tally results by angle. Output files *MUST* be in order from 00 to 90 degrees\r\n#radii are the distances of detector cells from seed,  \r\nbuildTallyDF <- function(file.dir = \"AnisoOutFiles\", first.cell=7, radii=c(0.25,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1,1.25,1.5,1.75,2,2.5,3,3.5,4,4.5,5,6,7,8,9,10)){\r\n  #Add radii column\r\n  TallyDF <- data.frame(\"r\"=radii)\r\n  #For each file in the directory create vector of appropriate cell values, append to DF\r\n  for(file.name in list.files(file.dir)){\r\n    file <- scan(paste0(file.dir,\"/\",file.name), character(0), sep = \"\\n\")\r\n    f6vals <- c()\r\n    \r\n    for(i in seq(first.cell, first.cell+length(radii)-1)){\r\n      cellval <- which(is.na(str_extract(file,paste0(\"cell  \",i)))==FALSE)\r\n      cellval <- file[cellval + 1]\r\n      cellval <- as.numeric(unlist(str_split(str_trim(cellval), \" \"))[1])\r\n      f6vals <- append(f6vals, cellval)\r\n    }\r\n    \r\n    first.cell <- first.cell + length(radii)\r\n    TallyDF <- data.frame(TallyDF, file.name = f6vals)\r\n    \r\n  }\r\n  #rename columns using their respective angles\r\n  colnames(TallyDF)<- c(\"r\", seq(0,90, by=10))\r\n  return(TallyDF)\r\n}\r\n#buildTallyDF()\r\n{% endhighlight %}\r\n\r\nNext, we use the newly created dataframe, `buildAnisoDF()`, to calculate the 2D anisotropy function using the above formula:\r\n\r\n\r\n\r\n{% highlight r %}\r\nAniso <- function(){\r\n  TallyDF <- buildTallyDF()\r\n  #Divide all tally values by the tally value of that radius at 90 degrees\r\n  AnisoDF <- TallyDF[,-1]/TallyDF[,\"90\"]\r\n  AnisoDF <- cbind(\"r\"=TallyDF[,1], AnisoDF)\r\n  \r\n  #At each position of the Aniso dataframe, multiply the aniso value by the geometry function at that point\r\n  for(angle in colnames(AnisoDF[,-1])){\r\n    \r\n    for(radius in AnisoDF[,\"r\"]){\r\n      \r\n     AnisoDF[AnisoDF$r==radius, angle] <- AnisoDF[AnisoDF$r==radius, angle] * GeomFunction(pi/2, radius) / GeomFunction(as.numeric(angle)*pi/180, radius)\r\n  }}\r\n      \r\n  \r\n  return(AnisoDF) \r\n  }\r\n  Aniso()\r\n{% endhighlight %}\r\n\r\n\r\n\r\n{% highlight text %}\r\n##        r    0   10   20   30   40   50   60   70   80 90\r\n## 1   0.25 0.20 0.49 0.94 1.05 1.08 1.07 0.97 0.99 1.00  1\r\n## 2   0.30 0.19 0.46 0.82 1.00 1.05 1.07 1.01 0.99 1.00  1\r\n## 3   0.40 0.21 0.47 0.75 0.94 1.02 1.05 1.07 0.99 1.00  1\r\n## 4   0.50 0.22 0.48 0.73 0.91 1.00 1.04 1.06 1.06 1.00  1\r\n## 5   0.60 0.24 0.51 0.73 0.89 0.99 1.04 1.06 1.07 1.00  1\r\n## 6   0.70 0.26 0.52 0.74 0.89 0.99 1.03 1.06 1.06 1.00  1\r\n## 7   0.80 0.28 0.54 0.74 0.88 0.98 1.03 1.05 1.06 1.00  1\r\n## 8   0.90 0.29 0.55 0.75 0.88 0.98 1.03 1.05 1.06 1.05  1\r\n## 9   1.00 0.31 0.56 0.75 0.88 0.97 1.02 1.05 1.06 1.06  1\r\n## 10  1.25 0.35 0.59 0.76 0.88 0.97 1.02 1.04 1.06 1.06  1\r\n## 11  1.50 0.38 0.61 0.77 0.88 0.96 1.02 1.04 1.05 1.05  1\r\n## 12  1.75 0.41 0.63 0.78 0.89 0.96 1.01 1.04 1.05 1.05  1\r\n## 13  2.00 0.42 0.64 0.79 0.89 0.96 1.01 1.03 1.05 1.05  1\r\n## 14  2.50 0.46 0.66 0.80 0.89 0.96 1.01 1.03 1.04 1.05  1\r\n## 15  3.00 0.49 0.68 0.81 0.90 0.96 1.00 1.03 1.04 1.04  1\r\n## 16  3.50 0.53 0.70 0.81 0.90 0.96 1.00 1.02 1.04 1.04  1\r\n## 17  4.00 0.57 0.71 0.82 0.90 0.96 1.00 1.02 1.03 1.04  1\r\n## 18  4.50 0.59 0.72 0.83 0.90 0.96 1.00 1.02 1.03 1.03  1\r\n## 19  5.00 0.63 0.73 0.83 0.90 0.95 0.99 1.02 1.03 1.03  1\r\n## 20  6.00 0.65 0.74 0.84 0.90 0.95 0.99 1.01 1.02 1.03  1\r\n## 21  7.00 0.68 0.76 0.84 0.90 0.95 0.99 1.01 1.02 1.02  1\r\n## 22  8.00 0.69 0.76 0.85 0.91 0.95 0.99 1.01 1.02 1.02  1\r\n## 23  9.00 0.72 0.77 0.85 0.91 0.95 0.99 1.01 1.02 1.02  1\r\n## 24 10.00 0.74 0.78 0.85 0.91 0.95 0.98 1.00 1.01 1.02  1\r\n{% endhighlight %}\r\n\r\n##Plots\r\n\r\n###Radial Dose Function\r\n\r\nHere is the radial dose function plotted against several other published seed results (other seed data from external .csv):\r\n\r\n\r\n{% highlight r %}\r\nradialPlot()\r\n{% endhighlight %}\r\n\r\n<img src=\"http://i.imgur.com/LEpdWnt.png\" title=\"source: imgur.com\" />\r\n\r\nAnd a zoom in of the area of interest from r = 0 to r = 2:\r\n\r\n\r\n\r\n{% highlight r %}\r\nradialPlotZoom()\r\n{% endhighlight %}\r\n\r\n<img src=\"http://i.imgur.com/SPHlbIw.png\" title=\"source: imgur.com\" />\r\n\r\n###2D Anisotropy\r\n\r\nInspiration for the following plot was taken from [Rivard 2008](http://scitation.aip.org/content/aapm/journal/medphys/36/2/10.1118/1.3056463).  In this plot the dotted lines are the KAERI seed, and the solid lines the IAI-125 seed.\r\n\r\n\r\n\r\n{% highlight r %}\r\nplotAniso()  \r\n{% endhighlight %}\r\n\r\n<img src=\"http://i.imgur.com/G4H9KWT.png\" title=\"source: imgur.com\" />\r\n\r\n##Conclusion\r\n\r\nCalculations for TG-43 parameters of a novel brachytherapy seed were presented. The functions should be generalizable, perhaps with some slight modifications.\r\n\r\n  ","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}